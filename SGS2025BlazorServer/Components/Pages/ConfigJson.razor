@page "/config"
@using CMS_Data.Interfaces
@inject IConfigService configService

<h3>Cấu hình hệ thống</h3>

@if (config == null)
{
    <p>Đang tải...</p>
}
else
{
    <EditForm Model="config" OnValidSubmit="SaveConfig">
        <div class="mb-3">
            <ul class="nav nav-tabs" id="configTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#system" type="button">System</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#print" type="button">Print</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#camera" type="button">Camera</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#barrier" type="button">Barrier</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#com" type="button">Com</button>
                </li>
            </ul>
        </div>

        <div class="tab-content p-3 border bg-light">
            <!-- System -->
            <div class="tab-pane fade show active" id="system">
                <InputCheckbox @bind-Value="config.System.UseBarrier" /> Sử dụng barrier <br />
                <InputCheckbox @bind-Value="config.System.UseCamera" /> Sử dụng camera <br />
                <InputCheckbox @bind-Value="config.System.LockScale" /> Khóa cân <br />
                <InputCheckbox @bind-Value="config.System.AutoScale" /> Tự động cân <br />
            </div>

            <!-- Print -->
            <div class="tab-pane fade" id="print">
                <label>Số bản in:</label>
                <InputNumber @bind-Value="config.Print.NumCopies" /> <br />
                <label>Template:</label>
                <InputSelect @bind-Value="config.Print.ScalePdfTemplate" class="form-select form-select-sm" style="width: 120px; display: inline-block;">
                    <option value="a4">A4</option>
                    <option value="a4_4anh">A4 (4 ảnh)</option>
                    <option value="a4_6anh">A4 (6 ảnh)</option>
                    <option value="a5_doc">A5 (dọc)</option>
                    <option value="a5_ngang">A5 (ngang)</option>
                </InputSelect> <br />
                <InputCheckbox @bind-Value="config.Print.NotView" /> Không xem trước <br />
            </div>

            <!-- Camera -->
            <div class="tab-pane fade" id="camera">
                @foreach (var cam in config.Camera.List)
                {
                    <div class="card mb-2 p-2">
                        <div class="row align-items-center g-2">
                            <div class="col-auto">
                                <b>@cam.Code</b>
                            </div>

                            <div class="col-auto">
                                <InputSelect @bind-Value="cam.TypeCamera" class="form-select form-select-sm">
                                    @foreach (var type in Enum.GetValues<CameraType>())
                                    {
                                        <option value="@type">@type</option>
                                    }
                                </InputSelect>
                            </div>

                            <div class="col-auto">
                                <label class="me-1">Bật</label>
                                <InputCheckbox @bind-Value="cam.IsEnabled" />
                            </div>

                            <div class="col-auto">
                                <InputText @bind-Value="cam.Url" class="form-control form-control-sm" placeholder="Url" style="width: 400px" />
                            </div>
                            <div class="col-auto">
                                <InputNumber @bind-Value="cam.DauGhiPort" class="form-control form-control-sm" placeholder="DauGhiPort" />
                            </div>
                            <div class="col-auto">
                                <InputText @bind-Value="cam.User" class="form-control form-control-sm" placeholder="User" style="width:100px" />
                            </div>

                            <div class="col">
                                <InputText @bind-Value="cam.Password" class="form-control form-control-sm" placeholder="Pass" />
                            </div>

                            <div class="col-auto">
                                <label class="me-1">Chụp ảnh</label>
                                <InputCheckbox @bind-Value="cam.Capture" />
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Barrier -->
            <div class="tab-pane fade" id="barrier">
                <table class="table table-bordered table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>IP</th>
                            <th>Port</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var b in config.Barrier)
                        {
                            <tr>
                                <td>
                                    <InputText @bind-Value="b.Ip" class="form-control form-control-sm" />
                                </td>
                                <td>
                                    <InputNumber @bind-Value="b.Port" class="form-control form-control-sm" />
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Com -->
            <div class="tab-pane fade" id="com">
                <div class="card p-3">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <label class="form-label">Port</label>
                            <InputText @bind-Value="config.ComConfig.PortName" class="form-control form-control-sm" />
                        </div>
                        <div class="col">
                            <label class="form-label">Baud</label>
                            <InputNumber @bind-Value="config.ComConfig.BaudRate" class="form-control form-control-sm" />
                        </div>
                        <div class="col">
                            <label class="form-label">Parity</label>
                            <InputText @bind-Value="config.ComConfig.Parity" class="form-control form-control-sm" />
                        </div>
                        <div class="col">
                            <label class="form-label">DataBits</label>
                            <InputNumber @bind-Value="config.ComConfig.DataBits" class="form-control form-control-sm" />
                        </div>
                        <div class="col">
                            <label class="form-label">StopBits</label>
                            <InputNumber @bind-Value="config.ComConfig.StopBits" class="form-control form-control-sm" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <button type="submit" class="btn btn-primary">💾 Lưu cấu hình</button>
        </div>
    </EditForm>
}

@code {
    private AppConfig? config;

    protected override async Task OnInitializedAsync()
    {
        config = await configService.LoadAsync();
    }

    private async Task SaveConfig()
    {
        await configService.SaveAsync(config);
    }
}
